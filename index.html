<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>3D Осмотр авто</title>
  <style>
    html,body{margin:0;height:100%;background:#0b0f14;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{position:fixed;inset:0}
    #c{width:100%;height:100%;display:block;touch-action:none}
    #top{
      position:fixed;left:0;right:0;top:0;
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:linear-gradient(to bottom, rgba(11,15,20,.92), rgba(11,15,20,.15));
      pointer-events:none;
    }
    #top > *{pointer-events:auto}
    .title{font-weight:700}
    .hint{opacity:.75;font-size:12px;margin-top:2px}
    button, select, input{
      font:inherit;color:inherit;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;
    }
    button{cursor:pointer}
    #panel{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(18,24,34,.92);backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,.10);
      padding:12px;display:grid;gap:10px;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:13px}
    .muted{opacity:.75;font-size:12px}
    #loading{
      position:fixed;inset:0;display:grid;place-items:center;
      background:rgba(11,15,20,.85);backdrop-filter: blur(6px);
    }
    .box{width:min(380px, 92vw);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;background:rgba(255,255,255,.06)}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden;margin-top:10px}
    .bar > div{height:100%;width:0%;background:rgba(255,255,255,.85)}
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="c"></canvas>

    <div id="top">
      <div>
        <div class="title">3D Осмотр</div>
        <div class="hint">Крути 1 пальцем • Тап по детали • 2 пальца = зум</div>
      </div>
      <button id="resetBtn">Сброс</button>
    </div>

    <div id="panel">
      <div class="row">
        <div class="chip">Деталь: <b id="partName">—</b></div>
        <div class="chip">Статус: <b id="partStatus">—</b></div>
      </div>

      <div class="row">
        <select id="statusSel">
          <option value="">— статус —</option>
          <option value="stock">Родное</option>
          <option value="painted">Покрашено</option>
          <option value="scratch">Царапина</option>
          <option value="dent">Вмятина</option>
          <option value="chip">Скол</option>
          <option value="crack">Трещина</option>
          <option value="stain">Пятно</option>
          <option value="polished">Полировано</option>
        </select>

        <input id="colorPick" type="color" value="#1b6cf0" />
        <button id="applyBtn">Применить</button>
        <button id="exportBtn">JSON</button>
      </div>

      <div class="muted">
        Лучше, чтобы в Blender у каждой детали был уникальный name (например: door_fl, hood, bumper_f).
      </div>
    </div>

    <div id="loading">
      <div class="box">
        <div style="font-weight:700">Загрузка модели… <span id="pct">0%</span></div>
        <div class="bar"><div id="bar"></div></div>
        <div class="muted" style="margin-top:10px">
          Если не грузит — смотри консоль (F12). Dropbox иногда блокирует CORS, тогда лучше перенести GLB в Supabase Storage/R2.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/loaders/GLTFLoader.js";

    // ✅ ТВОЙ DROPBOX GLB (прямая загрузка через raw=1)
    const MODEL_URL =
      "https://www.dropbox.com/scl/fi/u5x0ih97im0nilfcgnb6o/Cobalt.glb?rlkey=5wjpbdborttmvv7u47ai60lka&raw=1";

    const STATUS_COLOR = {
      stock:"#2ecc71", painted:"#f1c40f", scratch:"#e67e22", dent:"#e74c3c",
      chip:"#9b59b6", crack:"#3498db", stain:"#95a5a6", polished:"#1abc9c"
    };

    const storeKey = "car_inspect_state_v2";
    const state = JSON.parse(localStorage.getItem(storeKey) || "{}");
    const saveState = () => localStorage.setItem(storeKey, JSON.stringify(state));

    const canvas = document.getElementById("c");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false });
    renderer.setPixelRatio(Math.min(2, devicePixelRatio));
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.05;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0f14);

    const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 2000);
    camera.position.set(2.6, 1.6, 3.2);

    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.rotateSpeed = 0.8;
    controls.zoomSpeed = 0.8;
    controls.enablePan = false;

    scene.add(new THREE.HemisphereLight(0xffffff, 0x223344, 1.0));
    const keyLight = new THREE.DirectionalLight(0xffffff, 1.2);
    keyLight.position.set(5, 7, 4);
    scene.add(keyLight);
    const fillLight = new THREE.DirectionalLight(0xffffff, 0.35);
    fillLight.position.set(-6, 2, -4);
    scene.add(fillLight);

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();

    const partNameEl = document.getElementById("partName");
    const partStatusEl = document.getElementById("partStatus");
    const statusSel = document.getElementById("statusSel");
    const colorPick = document.getElementById("colorPick");

    const loadingEl = document.getElementById("loading");
    const pctEl = document.getElementById("pct");
    const barEl = document.getElementById("bar");

    let modelRoot = null;
    let selectedMesh = null;
    let helper = null;

    function ensureUniqueMaterial(mesh){
      if (!mesh.material) return;
      if (Array.isArray(mesh.material)) mesh.material = mesh.material.map(m => m.clone());
      else mesh.material = mesh.material.clone();
    }
    function setMeshColor(mesh, hex){
      ensureUniqueMaterial(mesh);
      const mats = Array.isArray(mesh.material) ? mesh.material : [mesh.material];
      mats.forEach(m => {
        if (m?.color) m.color.set(hex);
        m.needsUpdate = true;
      });
    }

    function applySavedToAll(){
      if (!modelRoot) return;
      modelRoot.traverse(n=>{
        if (!n.isMesh) return;
        const key = n.name || n.uuid;
        const s = state[key];
        if (s?.color) setMeshColor(n, s.color);
      });
    }

    function allMeshes(){
      const arr = [];
      modelRoot?.traverse(n => { if (n.isMesh) arr.push(n); });
      return arr;
    }

    function pick(clientX, clientY){
      const rect = canvas.getBoundingClientRect();
      pointer.x = ((clientX - rect.left)/rect.width)*2 - 1;
      pointer.y = -(((clientY - rect.top)/rect.height)*2 - 1);
      raycaster.setFromCamera(pointer, camera);
      return raycaster.intersectObjects(allMeshes(), true)[0]?.object || null;
    }

    function setHelper(mesh){
      if (helper) { scene.remove(helper); helper.geometry?.dispose?.(); helper = null; }
      if (!mesh) return;
      helper = new THREE.BoxHelper(mesh, 0xffffff);
      helper.material.transparent = true;
      helper.material.opacity = 0.75;
      scene.add(helper);
    }

    function selectMesh(mesh){
      selectedMesh = mesh;

      if (!mesh) {
        partNameEl.textContent = "—";
        partStatusEl.textContent = "—";
        statusSel.value = "";
        setHelper(null);
        return;
      }

      const key = mesh.name || mesh.uuid;
      partNameEl.textContent = mesh.name || "(без имени)";
      partStatusEl.textContent = state[key]?.status || "—";
      statusSel.value = state[key]?.status || "";
      colorPick.value = state[key]?.color || "#1b6cf0";
      setHelper(mesh);
    }

    // Тап без “срабатывания” при вращении:
    let downX=0, downY=0, downT=0, moved=false;
    canvas.addEventListener("pointerdown", (e)=>{
      downX = e.clientX; downY = e.clientY; downT = performance.now();
      moved = false;
    }, {passive:true});
    canvas.addEventListener("pointermove", (e)=>{
      if (Math.hypot(e.clientX-downX, e.clientY-downY) > 8) moved = true;
    }, {passive:true});
    canvas.addEventListener("pointerup", (e)=>{
      const dt = performance.now() - downT;
      if (moved || dt > 350) return; // это было вращение, не тап
      const obj = pick(e.clientX, e.clientY);
      if (obj) selectMesh(obj);
    }, {passive:true});

    statusSel.addEventListener("change", ()=>{
      const st = statusSel.value;
      if (st && STATUS_COLOR[st]) colorPick.value = STATUS_COLOR[st];
    });

    document.getElementById("applyBtn").addEventListener("click", ()=>{
      if (!selectedMesh) return;
      const key = selectedMesh.name || selectedMesh.uuid;

      const status = statusSel.value;
      const color = colorPick.value;

      state[key] = { status, color, updatedAt: Date.now() };
      setMeshColor(selectedMesh, color);
      partStatusEl.textContent = status || "—";
      saveState();
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "inspection.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      for (const k of Object.keys(state)) delete state[k];
      saveState();
      location.reload();
    });

    function frameObject(root){
      const box = new THREE.Box3().setFromObject(root);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());

      root.position.sub(center);

      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * (Math.PI / 180);
      let dist = (maxDim / 2) / Math.tan(fov / 2);
      dist *= 1.35;

      camera.position.set(dist * 0.85, dist * 0.45, dist);
      camera.near = dist / 100;
      camera.far  = dist * 50;
      camera.updateProjectionMatrix();

      controls.target.set(0, 0, 0);
      controls.minDistance = dist * 0.35;
      controls.maxDistance = dist * 2.2;
      controls.update();
    }

    const loader = new GLTFLoader();
    loader.load(
      MODEL_URL,
      (gltf)=>{
        modelRoot = gltf.scene;
        scene.add(modelRoot);
        frameObject(modelRoot);
        applySavedToAll();
        loadingEl.style.display = "none";
      },
      (xhr)=>{
        if (!xhr.total) return;
        const p = Math.round((xhr.loaded / xhr.total) * 100);
        pctEl.textContent = p + "%";
        barEl.style.width = p + "%";
      },
      (err)=>{
        console.error(err);
        alert("GLB не загрузился. Если в консоли ошибка CORS от Dropbox — перенеси GLB в Supabase Storage/R2 (там точно работает).");
      }
    );

    addEventListener("resize", ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      if (helper) helper.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
